@model haver.ViewModels.GanttDetailsViewModel

@{
    ViewData["Title"] = "Details";
}

<div class="container-fluid">
    
    <div class="row">
        <!-- Machine Details and Engineering & Approvals -->
        <div class="col-md-6">
            <div class="info-box p-3 bg-light border rounded mb-3">
                <h5 class="fw-bold text-center section-header">Machine Details</h5>
                <dl class="row">
                    <dt class="col-md-6">Machine & Serial Number</dt>
                    <dd class="col-md-6">@Model.GanttData.Machine.Description</dd>
                    <dt class="col-md-6">Order Number</dt>
                    <dd class="col-md-6">@Model.GanttData.Machine.SalesOrder.OrderNumber</dd>
                    <dt class="col-md-6">Customer</dt>
                    <dd class="col-md-6">@Model.GanttData.Machine.SalesOrder.CompanyName</dd>
                </dl>
            </div>

            <div class="info-box p-3 bg-light border rounded mb-3">
                <h5 class="fw-bold text-center section-header">Engineering & Approvals</h5>
                <dl class="row">
                    <dt class="col-md-6">Approval Drawings Received</dt>
                    <dd class="col-md-6">@Model.GanttData.AppDRcd?.ToString("MMM dd, yyyy")</dd>
                    <dt class="col-md-6">Engineering Expected</dt>
                    <dd class="col-md-6">@Model.GanttData.EngExpected?.ToString("MMM dd, yyyy")</dd>
                    <dt class="col-md-6">Engineering Released</dt>
                    <dd class="col-md-6">@Model.GanttData.EngReleased?.ToString("MMM dd, yyyy")</dd>
                    <dt class="col-md-6">Customer Approval</dt>
                    <dd class="col-md-6">@Model.GanttData.CustomerApproval?.ToString("MMM dd, yyyy")</dd>
                </dl>
            </div>
        </div>

        <!-- Production & Shipping Section -->
        <div class="col-md-6">
            <div class="info-box p-3 bg-light border rounded mb-3">
                <h5 class="fw-bold text-center section-header">Production & Shipping</h5>
                <dl class="row">
                    <dt class="col-md-6">Package Released</dt>
                    <dd class="col-md-6">@Model.GanttData.PackageReleased?.ToString("MMM dd, yyyy")</dd>
                    <dt class="col-md-6">Supplier PO Due</dt>
                    <dd class="col-md-6">@Model.GanttData.SupplierPODue?.ToString("d")</dd>
                    <dt class="col-md-6">Assembly Start</dt>
                    <dd class="col-md-6">@Model.GanttData.AssemblyStart?.ToString("d")</dd>
                    <dt class="col-md-6">Assembly Complete</dt>
                    <dd class="col-md-6">@Model.GanttData.AssemblyComplete?.ToString("d")</dd>
                    <dt class="col-md-6">Shipping Expected</dt>
                    <dd class="col-md-6">@Model.GanttData.ShipExpected?.ToString("d")</dd>
                    <dt class="col-md-6">Actual Shipping</dt>
                    <dd class="col-md-6">@Model.GanttData.ShipActual?.ToString("d")</dd>
                    <dt class="col-md-6">Delivery Expected</dt>
                    <dd class="col-md-6">@Model.GanttData.DeliveryExpected?.ToString("d")</dd>
                    <dt class="col-md-6">Actual Delivery</dt>
                    <dd class="col-md-6">@Model.GanttData.DeliveryActual?.ToString("d")</dd>
                </dl>
            </div>
        </div>
    </div>

    <!-- Gantt Chart Section -->
    <div class="row mt-3">
        <div class="col-md-12">
            <div class="info-box p-4 bg-light border rounded" style="height: 100%;">
                <div class="card-header bg-success text-white text-center">
                    <h5 class="mb-0">Gantt Chart</h5>
                </div>
                <div id="gantt" style="width: 100%; overflow-x: auto;"></div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            @if (!Model.GanttData.IsFinalized)
            {
                <a asp-action="Edit" asp-route-id="@Model.GanttData.ID" class="btn btn-primary me-2">Edit</a>
                <form asp-action="FinalizeGantt" method="post" style="display:inline;">
                    <input type="hidden" name="id" value="@Model.GanttData.ID" />
                    <button type="submit" class="btn btn-success me-2" onclick="return confirm('Are you sure you want to finalize this Gantt chart?');">
                        Finalize
                    </button>
                </form>
            }
            else
            {
                <span class="badge bg-success me-2">Finalized</span>
                <form asp-action="UnfinalizeGantt" method="post" style="display:inline;">
                    <input type="hidden" name="id" value="@Model.GanttData.ID" />
                    <button type="submit" class="btn btn-warning me-2" onclick="return confirm('Are you sure you want to unfinalize this Gantt chart?');">
                        Unfinalize
                    </button>
                </form>
            }
            <a asp-action="Index" class="btn btn-secondary">Back to List</a>
        </div>
    </div>
</div>


@section stylesheets {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.5.0/frappe-gantt.css">
    <style>
        .card-header h5 {
            font-weight: 600;
            margin: 0;
        }

        .info-box {
            flex-grow: 1;
            margin-bottom: 15px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            align-items: stretch;
        }

        .col-md-6 {
            display: flex;
            flex-direction: column;
        }

        .section-header {
            font-size: 1.2rem;
            text-transform: uppercase;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ddd;
            text-align: center;
        }

        dl.row {
            display: flex;
            flex-wrap: wrap;
        }

            dl.row dt, dl.row dd {
                width: 50%;
                padding: 8px 0;
                border-bottom: 1px solid #ddd;
            }

            dl.row dt {
                font-weight: 600;
                color: #444;
                text-align: left;
            }

            dl.row dd {
                text-align: right;
                color: #333;
            }

        #gantt {
            width: 100%;
            overflow-x: auto;
            min-height: 200px;
            max-height: 250px;
        }

        .info-box.gantt-container {
            padding: 15px;
            margin-bottom: 10px;
        }

        .card-header {
            padding: 8px 12px;
            font-size: 1.2rem;
        }

        .d-flex {
            align-items: center;
            justify-content: space-between;
            margin-top: 20px;
        }

            .d-flex .btn {
                margin-bottom: 10px;
            }

    </style>
}




@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.5.0/frappe-gantt.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var tasks = [
        @foreach (var task in Model.GanttTasks)
        {
            <text>
                        {
                            id: "@task.UniqueID", // Use UniqueID instead of ID
                        name: "@task.MachineName",
                        start: "@(task.StartDate?.ToString("yyyy-MM-dd") ?? "")",
                        end: "@(task.EndDate?.ToString("yyyy-MM-dd") ?? "")",
                        progress: 0,
                        custom_class: "@task.MilestoneClass"
                                    },
            </text>
        }
                    ];

            var gantt = new Gantt("#gantt", tasks, {
                on_click: function (task) {
                    alert("Clicked on " + task.name);
                },
                on_date_change: function (task, start, end) {
                    console.log(task.name, start, end);
                },
                on_progress_change: function (task, progress) {
                    console.log(task.name, progress);
                },
                on_view_change: function (mode) {
                    console.log("View mode changed to " + mode);
                },
                view_mode: 'Week',
                language: 'en',
                custom_popup_html: function (task) {
                    return `<div class="gantt-task-popup">
                                        <strong>${task.name}</strong><br>
                                        <small>${task.start} → ${task.end}</small>
                                    </div>`;
                }
            });

            // Apply colors AFTER rendering
            setTimeout(function () {
                tasks.forEach(task => {
                    let bars = document.querySelectorAll(`.bar-wrapper[data-id='${task.id}'] .bar`);
                    bars.forEach(bar => {
                        bar.style.fill = task.custom_class;
                    });
                });
            }, 500);
        });

    </script>
}
